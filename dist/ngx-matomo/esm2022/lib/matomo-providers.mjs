import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { ENVIRONMENT_INITIALIZER, PLATFORM_ID } from '@angular/core';
import { MATOMO_DEBUG_TRACING, MATOMO_ROUTE_TRACKING_INTERNAL_CONFIGURATION, MATOMO_TRACKERS_INTERNAL_CONFIGURATION, MATOMO_TRACKING_INTERNAL_CONFIGURATION, defaultRouteTrackingConfiguration, defaultTrackers, defaultTrackingConfiguration, } from './matomo-configuration';
import { MATOMO_TRACKER_GET_FUNCTION, MATOMO_TRACKER_INVOKE_FUNCTION, MATOMO_TRACKER_SET_FUNCTION, getFunctionFactory, invokeFunctionFactory, setFunctionFactory, } from './matomo-functions';
import { injectMatomoTrackingScriptFactory } from './matomo-inject-tracking-script';
import { MatomoRouteTracker } from './matomo-route-tracker.service';
import { MatomoTracker } from './matomo-tracker.service';
/**
 * Prepares Matomo tracking by returning a list of providers.
 *
 * @param {...*} features List of features to include in order to provide the correct list of providers.
 * @returns providers required for Matomo tracking.
 */
export function provideMatomoTracking(...features) {
    if (features.filter((it) => ['TRACKER_INJECTION', 'EXTERNAL_TRACKER', 'DUMMY_TRACKER'].includes(it.kind)).length > 1) {
        console.error('One and one only tracker configuration must be used.');
        return [];
    }
    try {
        window['_paq'] =
            window['_paq'] ||
                (features.find((it) => it.kind === 'TRACKER_INJECTION') ||
                    features.find((it) => it.kind === 'EXTERNAL_TRACKER')
                    ? []
                    : // eslint-disable-next-line @typescript-eslint/no-empty-function
                        { push: () => { } });
    }
    catch (e) {
        if (!(e instanceof ReferenceError))
            throw e;
    }
    const providers = [MatomoTracker];
    const debugTracingFeature = features.find((it) => it.kind === 'DEBUG_TRACING');
    providers.push({
        provide: MATOMO_DEBUG_TRACING,
        useValue: !!debugTracingFeature,
    });
    const routeTrackingFeature = features.find((it) => it.kind === 'ROUTE_TRACKING');
    if (routeTrackingFeature) {
        providers.push({
            provide: ENVIRONMENT_INITIALIZER,
            useFactory: (matomoRouteTracker) => () => {
                matomoRouteTracker.startTracking();
            },
            deps: [MatomoRouteTracker],
            multi: true,
        }, {
            provide: MATOMO_ROUTE_TRACKING_INTERNAL_CONFIGURATION,
            useValue: {
                ...defaultRouteTrackingConfiguration,
                ...routeTrackingFeature?.parameters,
            },
        });
    }
    const trackingConfigurationFeature = features.find((it) => it.kind === 'TRACKING_CONFIGURATION');
    if (trackingConfigurationFeature) {
        providers.push({
            provide: ENVIRONMENT_INITIALIZER,
            useFactory: (matomoTracker) => () => {
                // Disable use of sendBeacon for transmitting tracked events
                if (trackingConfigurationFeature.parameters.doNotUserSendBeacon)
                    matomoTracker.disableAlwaysUseSendBeacon();
                // Disable cookies if specified
                if (trackingConfigurationFeature.parameters.disableCookies)
                    matomoTracker.disableCookies();
                // Disable cross domain linking if specified
                // TODO: investigate how this is done with GTM parameters.
                // if (trackingConfigurationFeature.parameters.disableCrossDomainLinking)
                //   matomoTracker.disableCrossDomainLinking();
                // Set cookie domain if specified
                if (trackingConfigurationFeature.parameters.cookieDomain)
                    matomoTracker.setCookieDomain(trackingConfigurationFeature.parameters.cookieDomain);
                // Set cookie path if specified
                if (trackingConfigurationFeature.parameters.cookiePath)
                    matomoTracker.setCookiePath(trackingConfigurationFeature.parameters.cookiePath);
                // Set cookie same site if specified
                if (trackingConfigurationFeature.parameters.cookieSameSite)
                    matomoTracker.setCookieSameSite(trackingConfigurationFeature.parameters.cookieSameSite);
                // Set secure cookies if specified
                if (trackingConfigurationFeature.parameters.secureCookie)
                    matomoTracker.setSecureCookie(true);
                // Enable Browser Feature Detection if specified
                if (trackingConfigurationFeature.parameters.detectBrowserFeatures)
                    matomoTracker.enableBrowserFeatureDetection();
                // Enable JavaScript error tracking (as events)
                if (trackingConfigurationFeature.parameters.trackJavaScriptErrors)
                    matomoTracker.enableJSErrorTracking();
                // Enable Heart Beat Timer if specified
                if (typeof trackingConfigurationFeature.parameters.heartBeatTimer !== 'number')
                    matomoTracker.enableHeartBeatTimer(trackingConfigurationFeature.parameters.heartBeatTimer);
                // Set local domains
                if (Array.isArray(trackingConfigurationFeature.parameters.localDomains))
                    matomoTracker.setDomains(trackingConfigurationFeature.parameters.localDomains);
                // Enable DoNotTrack
                if (trackingConfigurationFeature.parameters.enableDoNotTrack)
                    matomoTracker.setDoNotTrack(true);
                // Require the right consent
                if (trackingConfigurationFeature.parameters?.consentRequirement === 'TRACKING')
                    matomoTracker.requireConsent();
                else if (trackingConfigurationFeature.parameters?.consentRequirement === 'COOKIE')
                    matomoTracker.requireCookieConsent();
                // Set global custom dimensions
                trackingConfigurationFeature.parameters.customDimensions?.forEach((it) => {
                    matomoTracker.setCustomDimension(it.index, it.value);
                });
                // Disable Campaign Parameters Tracking
                if (trackingConfigurationFeature.parameters.disableCampaignParametersTracking)
                    matomoTracker.disableCampaignParameters();
            },
            deps: [MatomoTracker],
            multi: true,
        }, {
            provide: MATOMO_TRACKING_INTERNAL_CONFIGURATION,
            useValue: {
                ...defaultTrackingConfiguration,
                ...trackingConfigurationFeature?.parameters,
            },
        });
    }
    const mockedTrackerFeature = features.find((it) => it.kind === 'DUMMY_TRACKER');
    if (mockedTrackerFeature) {
        // TODO: Changer l'injection des fonctions set / get / invoke
    }
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    const preloadedTrackerFeature = features.find((it) => it.kind === 'EXTERNAL_TRACKER');
    const trackerInjectionFeature = features.find((it) => it.kind === 'TRACKER_INJECTION');
    if (trackerInjectionFeature) {
        providers.push({
            provide: ENVIRONMENT_INITIALIZER,
            useFactory: (trackers, document, debugTracing) => () => trackers.then(injectMatomoTrackingScriptFactory(document, debugTracing)),
            deps: [MATOMO_TRACKERS_INTERNAL_CONFIGURATION, DOCUMENT, MATOMO_DEBUG_TRACING],
            multi: true,
        });
    }
    return [
        ...providers,
        {
            provide: MATOMO_TRACKERS_INTERNAL_CONFIGURATION,
            useFactory: () => Promise.all([defaultTrackers, trackerInjectionFeature?.parameters]).then(([defaultTrackers, trackers]) => ({
                ...defaultTrackers,
                ...trackers,
            })),
        },
        {
            provide: ENVIRONMENT_INITIALIZER,
            useFactory: (platformId) => () => {
                if (!isPlatformBrowser(platformId))
                    console.warn('ngx-Matomo is active only on browser platform.');
            },
            deps: [PLATFORM_ID],
            multi: true,
        },
        {
            provide: MATOMO_TRACKER_SET_FUNCTION,
            useFactory: (platformId, debugTracing) => setFunctionFactory(!isPlatformBrowser(platformId), debugTracing),
            deps: [PLATFORM_ID, MATOMO_DEBUG_TRACING],
        },
        {
            provide: MATOMO_TRACKER_GET_FUNCTION,
            useFactory: (platformId, debugTracing) => getFunctionFactory(!isPlatformBrowser(platformId), debugTracing),
            deps: [PLATFORM_ID],
        },
        {
            provide: MATOMO_TRACKER_INVOKE_FUNCTION,
            useFactory: (platformId, debugTracing) => invokeFunctionFactory(!isPlatformBrowser(platformId), debugTracing),
            deps: [PLATFORM_ID],
        },
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0b21vLXByb3ZpZGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1tYXRvbW8vc3JjL2xpYi9tYXRvbW8tcHJvdmlkZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsV0FBVyxFQUFZLE1BQU0sZUFBZSxDQUFDO0FBRS9FLE9BQU8sRUFDTCxvQkFBb0IsRUFDcEIsNENBQTRDLEVBQzVDLHNDQUFzQyxFQUN0QyxzQ0FBc0MsRUFJdEMsaUNBQWlDLEVBQ2pDLGVBQWUsRUFDZiw0QkFBNEIsR0FDN0IsTUFBTSx3QkFBd0IsQ0FBQztBQUVoQyxPQUFPLEVBQ0wsMkJBQTJCLEVBQzNCLDhCQUE4QixFQUM5QiwyQkFBMkIsRUFDM0Isa0JBQWtCLEVBQ2xCLHFCQUFxQixFQUNyQixrQkFBa0IsR0FDbkIsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QixPQUFPLEVBQUUsaUNBQWlDLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNwRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNwRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFZekQ7Ozs7O0dBS0c7QUFDSCxNQUFNLFVBQVUscUJBQXFCLENBQUMsR0FBRyxRQUF5QjtJQUNoRSxJQUNFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUNyQixDQUFDLG1CQUFtQixFQUFFLGtCQUFrQixFQUFFLGVBQWUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQzdFLENBQUMsTUFBTSxHQUFHLENBQUMsRUFDWixDQUFDO1FBQ0QsT0FBTyxDQUFDLEtBQUssQ0FBQyxzREFBc0QsQ0FBQyxDQUFDO1FBQ3RFLE9BQU8s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a0IsRUFBRSxZQUFxQixFQUFFLEVBQUUsQ0FDeEQsa0JBQWtCLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsRUFBRSxZQUFZLENBQUM7WUFDbEUsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLG9CQUFvQixDQUFDO1NBQzFDO1FBQ0Q7WUFDRSxPQUFPLEVBQUUsMkJBQTJCO1lBQ3BDLFVBQVUsRUFBRSxDQUFDLFVBQWtCLEVBQUUsWUFBcUIsRUFBRSxFQUFFLENBQ3hELGtCQUFrQixDQUFDLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDLEVBQUUsWUFBWSxDQUFDO1lBQ2xFLElBQUksRUFBRSxDQUFDLFdBQVcsQ0FBQztTQUNwQjtRQUNEO1lBQ0UsT0FBTyxFQUFFLDhCQUE4QjtZQUN2QyxVQUFVLEVBQUUsQ0FBQyxVQUFrQixFQUFFLFlBQXFCLEVBQUUsRUFBRSxDQUN4RCxxQkFBcUIsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxFQUFFLFlBQVksQ0FBQztZQUNyRSxJQUFJLEVBQUUsQ0FBQyxXQUFXLENBQUM7U0FDcEI7S0FDRixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERPQ1VNRU5ULCBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBFTlZJUk9OTUVOVF9JTklUSUFMSVpFUiwgUExBVEZPUk1fSUQsIFByb3ZpZGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7XG4gIE1BVE9NT19ERUJVR19UUkFDSU5HLFxuICBNQVRPTU9fUk9VVEVfVFJBQ0tJTkdfSU5URVJOQUxfQ09ORklHVVJBVElPTixcbiAgTUFUT01PX1RSQUNLRVJTX0lOVEVSTkFMX0NPTkZJR1VSQVRJT04sXG4gIE1BVE9NT19UUkFDS0lOR19JTlRFUk5BTF9DT05GSUdVUkFUSU9OLFxuICBNYXRvbW9Sb3V0ZVRyYWNraW5nQ29uZmlndXJhdGlvbixcbiAgTWF0b21vVHJhY2tlcnMsXG4gIE1hdG9tb1RyYWNraW5nQ29uZmlndXJhdGlvbixcbiAgZGVmYXVsdFJvdXRlVHJhY2tpbmdDb25maWd1cmF0aW9uLFxuICBkZWZhdWx0VHJhY2tlcnMsXG4gIGRlZmF1bHRUcmFja2luZ0NvbmZpZ3VyYXRpb24sXG59IGZyb20gJy4vbWF0b21vLWNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IHsgTWF0b21vRmVhdHVyZSB9IGZyb20gJy4vbWF0b21vLWZlYXR1cmVzJztcbmltcG9ydCB7XG4gIE1BVE9NT19UUkFDS0VSX0dFVF9GVU5DVElPTixcbiAgTUFUT01PX1RSQUNLRVJfSU5WT0tFX0ZVTkNUSU9OLFxuICBNQVRPTU9fVFJBQ0tFUl9TRVRfRlVOQ1RJT04sXG4gIGdldEZ1bmN0aW9uRmFjdG9yeSxcbiAgaW52b2tlRnVuY3Rpb25GYWN0b3J5LFxuICBzZXRGdW5jdGlvbkZhY3RvcnksXG59IGZyb20gJy4vbWF0b21vLWZ1bmN0aW9ucyc7XG5pbXBvcnQgeyBpbmplY3RNYXRvbW9UcmFja2luZ1NjcmlwdEZhY3RvcnkgfSBmcm9tICcuL21hdG9tby1pbmplY3QtdHJhY2tpbmctc2NyaXB0JztcbmltcG9ydCB7IE1hdG9tb1JvdXRlVHJhY2tlciB9IGZyb20gJy4vbWF0b21vLXJvdXRlLXRyYWNrZXIuc2VydmljZSc7XG5pbXBvcnQgeyBNYXRvbW9UcmFja2VyIH0gZnJvbSAnLi9tYXRvbW8tdHJhY2tlci5zZXJ2aWNlJztcblxuZGVjbGFyZSBnbG9iYWwge1xuICAvKipcbiAgICogRXh0ZW5kIFdpbmRvdyBpbnRlcmZhY2UgaW4gb3JkZXIgdG8gaW50cm9kdWNlIHRoZSBNYXRvbW8gX3BhcSBhdHRyaWJ1dGVcbiAgICovXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvY29uc2lzdGVudC10eXBlLWRlZmluaXRpb25zXG4gIGludGVyZmFjZSBXaW5kb3cge1xuICAgIF9wYXE6IHsgcHVzaDogKGFyZ3M6IHVua25vd25bXSkgPT4gdm9pZCB9O1xuICB9XG59XG5cbi8qKlxuICogUHJlcGFyZXMgTWF0b21vIHRyYWNraW5nIGJ5IHJldHVybmluZyBhIGxpc3Qgb2YgcHJvdmlkZXJzLlxuICpcbiAqIEBwYXJhbSB7Li4uKn0gZmVhdHVyZXMgTGlzdCBvZiBmZWF0dXJlcyB0byBpbmNsdWRlIGluIG9yZGVyIHRvIHByb3ZpZGUgdGhlIGNvcnJlY3QgbGlzdCBvZiBwcm92aWRlcnMuXG4gKiBAcmV0dXJucyBwcm92aWRlcnMgcmVxdWlyZWQgZm9yIE1hdG9tbyB0cmFja2luZy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHByb3ZpZGVNYXRvbW9UcmFja2luZyguLi5mZWF0dXJlczogTWF0b21vRmVhdHVyZVtdKSB7XG4gIGlmIChcbiAgICBmZWF0dXJlcy5maWx0ZXIoKGl0KSA9PlxuICAgICAgWydUUkFDS0VSX0lOSkVDVElPTicsICdFWFRFUk5BTF9UUkFDS0VSJywgJ0RVTU1ZX1RSQUNLRVInXS5pbmNsdWRlcyhpdC5raW5kKSxcbiAgICApLmxlbmd0aCA+IDFcbiAgKSB7XG4gICAgY29uc29sZS5lcnJvcignT25lIGFuZCBvbmUgb25seSB0cmFja2VyIGNvbmZpZ3VyYXRpb24gbXVzdCBiZSB1c2VkLicpO1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgd2luZG93WydfcGFxJ10gPVxuICAgICAgd2luZG93WydfcGFxJ10gfHxcbiAgICAgIChmZWF0dXJlcy5maW5kKChpdCkgPT4gaXQua2luZCA9PT0gJ1RSQUNLRVJfSU5KRUNUSU9OJykgfHxcbiAgICAgIGZlYXR1cmVzLmZpbmQoKGl0KSA9PiBpdC5raW5kID09PSAnRVhURVJOQUxfVFJBQ0tFUicpXG4gICAgICAgID8gW11cbiAgICAgICAgOiAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWVtcHR5LWZ1bmN0aW9uXG4gICAgICAgICAgeyBwdXNoOiAoKSA9PiB7fSB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghKGUgaW5zdGFuY2VvZiBSZWZlcmVuY2VFcnJvcikpIHRocm93IGU7XG4gIH1cblxuICBjb25zdCBwcm92aWRlcnM6IFByb3ZpZGVyW10gPSBbTWF0b21vVHJhY2tlcl07XG5cbiAgY29uc3QgZGVidWdUcmFjaW5nRmVhdHVyZSA9IGZlYXR1cmVzLmZpbmQoKGl0KSA9PiBpdC5raW5kID09PSAnREVCVUdfVFJBQ0lORycpO1xuICBwcm92aWRlcnMucHVzaCh7XG4gICAgcHJvdmlkZTogTUFUT01PX0RFQlVHX1RSQUNJTkcsXG4gICAgdXNlVmFsdWU6ICEhZGVidWdUcmFjaW5nRmVhdHVyZSxcbiAgfSk7XG5cbiAgY29uc3Qgcm91dGVUcmFja2luZ0ZlYXR1cmUgPSBmZWF0dXJlcy5maW5kKChpdCkgPT4gaXQua2luZCA9PT0gJ1JPVVRFX1RSQUNLSU5HJykgYXNcbiAgICB8IHtcbiAgICAgICAga2luZDogJ1JPVVRFX1RSQUNLSU5HJztcbiAgICAgICAgcGFyYW1ldGVyczogUGFydGlhbDxNYXRvbW9Sb3V0ZVRyYWNraW5nQ29uZmlndXJhdGlvbj47XG4gICAgICB9XG4gICAgfCB1bmRlZmluZWQ7XG4gIGlmIChyb3V0ZVRyYWNraW5nRmVhdHVyZSkge1xuICAgIHByb3ZpZGVycy5wdXNoKFxuICAgICAge1xuICAgICAgICBwcm92aWRlOiBFTlZJUk9OTUVOVF9JTklUSUFMSVpFUixcbiAgICAgICAgdXNlRmFjdG9yeTogKG1hdG9tb1JvdXRlVHJhY2tlcjogTWF0b21vUm91dGVUcmFja2VyKSA9PiAoKSA9PiB7XG4gICAgICAgICAgbWF0b21vUm91dGVUcmFja2VyLnN0YXJ0VHJhY2tpbmcoKTtcbiAgICAgICAgfSxcbiAgICAgICAgZGVwczogW01hdG9tb1JvdXRlVHJhY2tlcl0sXG4gICAgICAgIG11bHRpOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgcHJvdmlkZTogTUFUT01PX1JPVVRFX1RSQUNLSU5HX0lOVEVSTkFMX0NPTkZJR1VSQVRJT04sXG4gICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgLi4uZGVmYXVsdFJvdXRlVHJhY2tpbmdDb25maWd1cmF0aW9uLFxuICAgICAgICAgIC4uLnJvdXRlVHJhY2tpbmdGZWF0dXJlPy5wYXJhbWV0ZXJzLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICApO1xuICB9XG5cbiAgY29uc3QgdHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZSA9IGZlYXR1cmVzLmZpbmQoXG4gICAgKGl0KSA9PiBpdC5raW5kID09PSAnVFJBQ0tJTkdfQ09ORklHVVJBVElPTicsXG4gICkgYXNcbiAgICB8IHtcbiAgICAgICAga2luZDogJ1RSQUNLSU5HX0NPTkZJR1VSQVRJT04nO1xuICAgICAgICBwYXJhbWV0ZXJzOiBQYXJ0aWFsPE1hdG9tb1RyYWNraW5nQ29uZmlndXJhdGlvbj47XG4gICAgICB9XG4gICAgfCB1bmRlZmluZWQ7XG4gIGlmICh0cmFja2luZ0NvbmZpZ3VyYXRpb25GZWF0dXJlKSB7XG4gICAgcHJvdmlkZXJzLnB1c2goXG4gICAgICB7XG4gICAgICAgIHByb3ZpZGU6IEVOVklST05NRU5UX0lOSVRJQUxJWkVSLFxuICAgICAgICB1c2VGYWN0b3J5OiAobWF0b21vVHJhY2tlcjogTWF0b21vVHJhY2tlcikgPT4gKCkgPT4ge1xuICAgICAgICAgIC8vIERpc2FibGUgdXNlIG9mIHNlbmRCZWFjb24gZm9yIHRyYW5zbWl0dGluZyB0cmFja2VkIGV2ZW50c1xuICAgICAgICAgIGlmICh0cmFja2luZ0NvbmZpZ3VyYXRpb25GZWF0dXJlLnBhcmFtZXRlcnMuZG9Ob3RVc2VyU2VuZEJlYWNvbilcbiAgICAgICAgICAgIG1hdG9tb1RyYWNrZXIuZGlzYWJsZUFsd2F5c1VzZVNlbmRCZWFjb24oKTtcblxuICAgICAgICAgIC8vIERpc2FibGUgY29va2llcyBpZiBzcGVjaWZpZWRcbiAgICAgICAgICBpZiAodHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZS5wYXJhbWV0ZXJzLmRpc2FibGVDb29raWVzKVxuICAgICAgICAgICAgbWF0b21vVHJhY2tlci5kaXNhYmxlQ29va2llcygpO1xuXG4gICAgICAgICAgLy8gRGlzYWJsZSBjcm9zcyBkb21haW4gbGlua2luZyBpZiBzcGVjaWZpZWRcbiAgICAgICAgICAvLyBUT0RPOiBpbnZlc3RpZ2F0ZSBob3cgdGhpcyBpcyBkb25lIHdpdGggR1RNIHBhcmFtZXRlcnMuXG4gICAgICAgICAgLy8gaWYgKHRyYWNraW5nQ29uZmlndXJhdGlvbkZlYXR1cmUucGFyYW1ldGVycy5kaXNhYmxlQ3Jvc3NEb21haW5MaW5raW5nKVxuICAgICAgICAgIC8vICAgbWF0b21vVHJhY2tlci5kaXNhYmxlQ3Jvc3NEb21haW5MaW5raW5nKCk7XG5cbiAgICAgICAgICAvLyBTZXQgY29va2llIGRvbWFpbiBpZiBzcGVjaWZpZWRcbiAgICAgICAgICBpZiAodHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZS5wYXJhbWV0ZXJzLmNvb2tpZURvbWFpbilcbiAgICAgICAgICAgIG1hdG9tb1RyYWNrZXIuc2V0Q29va2llRG9tYWluKHRyYWNraW5nQ29uZmlndXJhdGlvbkZlYXR1cmUucGFyYW1ldGVycy5jb29raWVEb21haW4pO1xuXG4gICAgICAgICAgLy8gU2V0IGNvb2tpZSBwYXRoIGlmIHNwZWNpZmllZFxuICAgICAgICAgIGlmICh0cmFja2luZ0NvbmZpZ3VyYXRpb25GZWF0dXJlLnBhcmFtZXRlcnMuY29va2llUGF0aClcbiAgICAgICAgICAgIG1hdG9tb1RyYWNrZXIuc2V0Q29va2llUGF0aCh0cmFja2luZ0NvbmZpZ3VyYXRpb25GZWF0dXJlLnBhcmFtZXRlcnMuY29va2llUGF0aCk7XG5cbiAgICAgICAgICAvLyBTZXQgY29va2llIHNhbWUgc2l0ZSBpZiBzcGVjaWZpZWRcbiAgICAgICAgICBpZiAodHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZS5wYXJhbWV0ZXJzLmNvb2tpZVNhbWVTaXRlKVxuICAgICAgICAgICAgbWF0b21vVHJhY2tlci5zZXRDb29raWVTYW1lU2l0ZSh0cmFja2luZ0NvbmZpZ3VyYXRpb25GZWF0dXJlLnBhcmFtZXRlcnMuY29va2llU2FtZVNpdGUpO1xuXG4gICAgICAgICAgLy8gU2V0IHNlY3VyZSBjb29raWVzIGlmIHNwZWNpZmllZFxuICAgICAgICAgIGlmICh0cmFja2luZ0NvbmZpZ3VyYXRpb25GZWF0dXJlLnBhcmFtZXRlcnMuc2VjdXJlQ29va2llKVxuICAgICAgICAgICAgbWF0b21vVHJhY2tlci5zZXRTZWN1cmVDb29raWUodHJ1ZSk7XG5cbiAgICAgICAgICAvLyBFbmFibGUgQnJvd3NlciBGZWF0dXJlIERldGVjdGlvbiBpZiBzcGVjaWZpZWRcbiAgICAgICAgICBpZiAodHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZS5wYXJhbWV0ZXJzLmRldGVjdEJyb3dzZXJGZWF0dXJlcylcbiAgICAgICAgICAgIG1hdG9tb1RyYWNrZXIuZW5hYmxlQnJvd3NlckZlYXR1cmVEZXRlY3Rpb24oKTtcblxuICAgICAgICAgIC8vIEVuYWJsZSBKYXZhU2NyaXB0IGVycm9yIHRyYWNraW5nIChhcyBldmVudHMpXG4gICAgICAgICAgaWYgKHRyYWNraW5nQ29uZmlndXJhdGlvbkZlYXR1cmUucGFyYW1ldGVycy50cmFja0phdmFTY3JpcHRFcnJvcnMpXG4gICAgICAgICAgICBtYXRvbW9UcmFja2VyLmVuYWJsZUpTRXJyb3JUcmFja2luZygpO1xuXG4gICAgICAgICAgLy8gRW5hYmxlIEhlYXJ0IEJlYXQgVGltZXIgaWYgc3BlY2lmaWVkXG4gICAgICAgICAgaWYgKHR5cGVvZiB0cmFja2luZ0NvbmZpZ3VyYXRpb25GZWF0dXJlLnBhcmFtZXRlcnMuaGVhcnRCZWF0VGltZXIgIT09ICdudW1iZXInKVxuICAgICAgICAgICAgbWF0b21vVHJhY2tlci5lbmFibGVIZWFydEJlYXRUaW1lcihcbiAgICAgICAgICAgICAgdHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZS5wYXJhbWV0ZXJzLmhlYXJ0QmVhdFRpbWVyLFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIFNldCBsb2NhbCBkb21haW5zXG4gICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZS5wYXJhbWV0ZXJzLmxvY2FsRG9tYWlucykpXG4gICAgICAgICAgICBtYXRvbW9UcmFja2VyLnNldERvbWFpbnModHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZS5wYXJhbWV0ZXJzLmxvY2FsRG9tYWlucyk7XG5cbiAgICAgICAgICAvLyBFbmFibGUgRG9Ob3RUcmFja1xuICAgICAgICAgIGlmICh0cmFja2luZ0NvbmZpZ3VyYXRpb25GZWF0dXJlLnBhcmFtZXRlcnMuZW5hYmxlRG9Ob3RUcmFjaylcbiAgICAgICAgICAgIG1hdG9tb1RyYWNrZXIuc2V0RG9Ob3RUcmFjayh0cnVlKTtcblxuICAgICAgICAgIC8vIFJlcXVpcmUgdGhlIHJpZ2h0IGNvbnNlbnRcbiAgICAgICAgICBpZiAodHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZS5wYXJhbWV0ZXJzPy5jb25zZW50UmVxdWlyZW1lbnQgPT09ICdUUkFDS0lORycpXG4gICAgICAgICAgICBtYXRvbW9UcmFja2VyLnJlcXVpcmVDb25zZW50KCk7XG4gICAgICAgICAgZWxzZSBpZiAodHJhY2tpbmdDb25maWd1cmF0aW9uRmVhdHVyZS5wYXJhbWV0ZXJzPy5jb25zZW50UmVxdWlyZW1lbnQgPT09ICdDT09LSUUnKVxuICAgICAgICAgICAgbWF0b21vVHJhY2tlci5yZXF1aXJlQ29va2llQ29uc2VudCgpO1xuXG4gICAgICAgICAgLy8gU2V0IGdsb2JhbCBjdXN0b20gZGltZW5zaW9uc1xuICAgICAgICAgIHRyYWNraW5nQ29uZmlndXJhdGlvbkZlYXR1cmUucGFyYW1ldGVycy5jdXN0b21EaW1lbnNpb25zPy5mb3JFYWNoKChpdCkgPT4ge1xuICAgICAgICAgICAgbWF0b21vVHJhY2tlci5zZXRDdXN0b21EaW1lbnNpb24oaXQuaW5kZXgsIGl0LnZhbHVlKTtcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIC8vIERpc2FibGUgQ2FtcGFpZ24gUGFyYW1ldGVycyBUcmFja2luZ1xuICAgICAgICAgIGlmICh0cmFja2luZ0NvbmZpZ3VyYXRpb25GZWF0dXJlLnBhcmFtZXRlcnMuZGlzYWJsZUNhbXBhaWduUGFyYW1ldGVyc1RyYWNraW5nKVxuICAgICAgICAgICAgbWF0b21vVHJhY2tlci5kaXNhYmxlQ2FtcGFpZ25QYXJhbWV0ZXJzKCk7XG4gICAgICAgIH0sXG4gICAgICAgIGRlcHM6IFtNYXRvbW9UcmFja2VyXSxcbiAgICAgICAgbXVsdGk6IHRydWUsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBwcm92aWRlOiBNQVRPTU9fVFJBQ0tJTkdfSU5URVJOQUxfQ09ORklHVVJBVElPTixcbiAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAuLi5kZWZhdWx0VHJhY2tpbmdDb25maWd1cmF0aW9uLFxuICAgICAgICAgIC4uLnRyYWNraW5nQ29uZmlndXJhdGlvbkZlYXR1cmU/LnBhcmFtZXRlcnMsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICk7XG4gIH1cblxuICBjb25zdCBtb2NrZWRUcmFja2VyRmVhdHVyZSA9IGZlYXR1cmVzLmZpbmQoKGl0KSA9PiBpdC5raW5kID09PSAnRFVNTVlfVFJBQ0tFUicpO1xuICBpZiAobW9ja2VkVHJhY2tlckZlYXR1cmUpIHtcbiAgICAvLyBUT0RPOiBDaGFuZ2VyIGwnaW5qZWN0aW9uIGRlcyBmb25jdGlvbnMgc2V0IC8gZ2V0IC8gaW52b2tlXG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzXG4gIGNvbnN0IHByZWxvYWRlZFRyYWNrZXJGZWF0dXJlID0gZmVhdHVyZXMuZmluZCgoaXQpID0+IGl0LmtpbmQgPT09ICdFWFRFUk5BTF9UUkFDS0VSJyk7XG5cbiAgY29uc3QgdHJhY2tlckluamVjdGlvbkZlYXR1cmUgPSBmZWF0dXJlcy5maW5kKChpdCkgPT4gaXQua2luZCA9PT0gJ1RSQUNLRVJfSU5KRUNUSU9OJykgYXNcbiAgICB8IHtcbiAgICAgICAga2luZDogJ1RSQUNLRVJfSU5KRUNUSU9OJztcbiAgICAgICAgcGFyYW1ldGVyczogUHJvbWlzZTxQYXJ0aWFsPE1hdG9tb1RyYWNrZXJzPj47XG4gICAgICB9XG4gICAgfCB1bmRlZmluZWQ7XG4gIGlmICh0cmFja2VySW5qZWN0aW9uRmVhdHVyZSkge1xuICAgIHByb3ZpZGVycy5wdXNoKHtcbiAgICAgIHByb3ZpZGU6IEVOVklST05NRU5UX0lOSVRJQUxJWkVSLFxuICAgICAgdXNlRmFjdG9yeTpcbiAgICAgICAgKHRyYWNrZXJzOiBQcm9taXNlPE1hdG9tb1RyYWNrZXJzPiwgZG9jdW1lbnQ6IERvY3VtZW50LCBkZWJ1Z1RyYWNpbmc6IGJvb2xlYW4pID0+ICgpID0+XG4gICAgICAgICAgdHJhY2tlcnMudGhlbihpbmplY3RNYXRvbW9UcmFja2luZ1NjcmlwdEZhY3RvcnkoZG9jdW1lbnQsIGRlYnVnVHJhY2luZykpXG4gICAgICAgICxcbiAgICAgIGRlcHM6IFtNQVRPTU9fVFJBQ0tFUlNfSU5URVJOQUxfQ09ORklHVVJBVElPTiwgRE9DVU1FTlQsIE1BVE9NT19ERUJVR19UUkFDSU5HXSxcbiAgICAgIG11bHRpOiB0cnVlLFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIFtcbiAgICAuLi5wcm92aWRlcnMsXG4gICAge1xuICAgICAgcHJvdmlkZTogTUFUT01PX1RSQUNLRVJTX0lOVEVSTkFMX0NPTkZJR1VSQVRJT04sXG4gICAgICB1c2VGYWN0b3J5OiAoKSA9PlxuICAgICAgICBQcm9taXNlLmFsbChbZGVmYXVsdFRyYWNrZXJzLCB0cmFja2VySW5qZWN0aW9uRmVhdHVyZT8ucGFyYW1ldGVyc10pLnRoZW4oXG4gICAgICAgICAgKFtkZWZhdWx0VHJhY2tlcnMsIHRyYWNrZXJzXSkgPT4gKHtcbiAgICAgICAgICAgIC4uLmRlZmF1bHRUcmFja2VycyxcbiAgICAgICAgICAgIC4uLnRyYWNrZXJzLFxuICAgICAgICAgIH0pLFxuICAgICAgICApLFxuICAgIH0sXG4gICAge1xuICAgICAgcHJvdmlkZTogRU5WSVJPTk1FTlRfSU5JVElBTElaRVIsXG4gICAgICB1c2VGYWN0b3J5OiAocGxhdGZvcm1JZDogb2JqZWN0KSA9PiAoKSA9PiB7XG4gICAgICAgIGlmICghaXNQbGF0Zm9ybUJyb3dzZXIocGxhdGZvcm1JZCkpXG4gICAgICAgICAgY29uc29sZS53YXJuKCduZ3gtTWF0b21vIGlzIGFjdGl2ZSBvbmx5IG9uIGJyb3dzZXIgcGxhdGZvcm0uJyk7XG4gICAgICB9LFxuICAgICAgZGVwczogW1BMQVRGT1JNX0lEXSxcbiAgICAgIG11bHRpOiB0cnVlLFxuICAgIH0sXG4gICAge1xuICAgICAgcHJvdmlkZTogTUFUT01PX1RSQUNLRVJfU0VUX0ZVTkNUSU9OLFxuICAgICAgdXNlRmFjdG9yeTogKHBsYXRmb3JtSWQ6IG9iamVjdCwgZGVidWdUcmFjaW5nOiBib29sZWFuKSA9PlxuICAgICAgICBzZXRGdW5jdGlvbkZhY3RvcnkoIWlzUGxhdGZvcm1Ccm93c2VyKHBsYXRmb3JtSWQpLCBkZWJ1Z1RyYWNpbmcpLFxuICAgICAgZGVwczogW1BMQVRGT1JNX0lELCBNQVRPTU9fREVCVUdfVFJBQ0lOR10sXG4gICAgfSxcbiAgICB7XG4gICAgICBwcm92aWRlOiBNQVRPTU9fVFJBQ0tFUl9HRVRfRlVOQ1RJT04sXG4gICAgICB1c2VGYWN0b3J5OiAocGxhdGZvcm1JZDogb2JqZWN0LCBkZWJ1Z1RyYWNpbmc6IGJvb2xlYW4pID0+XG4gICAgICAgIGdldEZ1bmN0aW9uRmFjdG9yeSghaXNQbGF0Zm9ybUJyb3dzZXIocGxhdGZvcm1JZCksIGRlYnVnVHJhY2luZyksXG4gICAgICBkZXBzOiBbUExBVEZPUk1fSURdLFxuICAgIH0sXG4gICAge1xuICAgICAgcHJvdmlkZTogTUFUT01PX1RSQUNLRVJfSU5WT0tFX0ZVTkNUSU9OLFxuICAgICAgdXNlRmFjdG9yeTogKHBsYXRmb3JtSWQ6IG9iamVjdCwgZGVidWdUcmFjaW5nOiBib29sZWFuKSA9PlxuICAgICAgICBpbnZva2VGdW5jdGlvbkZhY3RvcnkoIWlzUGxhdGZvcm1Ccm93c2VyKHBsYXRmb3JtSWQpLCBkZWJ1Z1RyYWNpbmcpLFxuICAgICAgZGVwczogW1BMQVRGT1JNX0lEXSxcbiAgICB9LFxuICBdO1xufVxuIl19